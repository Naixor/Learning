# Collapsing Margin

## 问题
遇到一个奇怪的CSS问题，HTML与CSS结构如下：
```html
<style>
	.container {
	  width: 100%;
	  background: red;
	  margin: 0 auto;
	}
	
	.logo {
	  display: block;
	  width: 400px;
	  height: 160px;
	  border: solid 1px black;
	  margin: 10px 0 20px 10px;
	  background: url(https://developer.cdn.mozilla.net/static/img/mdn10/logo-sprite@2x.c87e5baf1d09.png);
	}
</style>
<div class=".container">
	<a class="logo"></a>
</div>
```
其浏览效果如下，大家注意我对`container`的`margin`赋值为`0 auto`。这意味着他本应该靠在顶端，但是他却有了缝隙，如果将`logo`的`display`换成`inline-block`则显示如期望，空隙消失。感兴趣的可以自己玩下
<iframe height='268' width='500' scrolling='no' src='//codepen.io/Naixor/embed/LGGByP/?height=268&theme-id=0&default-tab=result' frameborder='no' allowtransparency='true' allowfullscreen='true' style='width: 100%;'>See the Pen <a href='http://codepen.io/Naixor/pen/LGGByP/'>LGGByP</a> by Stormspirit (<a href='http://codepen.io/Naixor'>@Naixor</a>) on <a href='http://codepen.io'>CodePen</a>.
</iframe>


## 原因

本着学问的角度，必定要知其所以然。导致上面问题的原因是由于**Margin Collapsing**，俗称**外边距折叠**。
不懂请找规范，下面截取了他的部分[规范描述](http://www.w3.org/TR/CSS2/box.html#collapsing-margins)：

> Two margins are adjoining if and only if:

+ both belong to in-flow block-level boxes that participate in the same block formatting context
+ no line boxes, no clearance, no padding and no border separate them (Note that certain zero-height line boxes (see 9.4.2) are ignored for this purpose.)
+ both belong to vertically-adjacent box edges, i.e. form one of the following pairs:
	+ top margin of a box and top margin of its first in-flow child
	+ bottom margin of box and top margin of its next in-flow following sibling
	+ bottom margin of a last in-flow child and bottom margin of its parent if the parent has 'auto' computed height
	+ top and bottom margins of a box that does not establish a new block formatting context and that has zero computed 'min-height', zero or 'auto' computed 'height', and no in-flow children

> A collapsed margin is considered adjoining to another margin if any of its component margins is adjoining to that margin.

+ Note. Adjoining margins can be generated by elements that are not related as siblings or ancestors.
+ Note the above rules imply that:
+ Margins between a floated box and any other box do not collapse (not even between a float and its in-flow children).
+ Margins of elements that establish new block formatting contexts (such as floats and elements with 'overflow' other than 'visible') do not collapse with their in-flow children.
+ Margins of absolutely positioned boxes do not collapse (not even with their in-flow children).
+ Margins of inline-block boxes do not collapse (not even with their in-flow children).
+ The bottom margin of an in-flow block-level element always collapses with the top margin of its next in-flow block-level sibling, unless that sibling has clearance.
+ The top margin of an in-flow block element collapses with its first in-flow block-level child's top margin if the element has no top border, no top padding, and the child has no clearance.
+ The bottom margin of an in-flow block box with a 'height' of 'auto' and a 'min-height' of zero collapses with its last in-flow block-level child's bottom margin if the box has no bottom padding and no bottom border and the child's bottom margin does not collapse with a top margin that has clearance.
+ A box's own margins collapse if the 'min-height' property is zero, and it has neither top or bottom borders nor top or bottom padding, and it has a 'height' of either 0 or 'auto', and it does not contain a line box, and all of its in-flow children's margins (if any) collapse.

### 通俗的解释下：`[]`内为我的注解

#### 首先解释下产生了margin折叠会有何影响：
> 以margin-top和margin-bottom折叠为例

+ 若两者都为正数，取max(top, bottom)为两者的值
+ 若两者都为负数，取min(top, bottom)为两者的值
+ 若一正一负，去top + bottom的值为两者的值

#### 下面解释下产生折叠和不产生折叠的情况：
**FLAG**：相邻margin（原文中的adjoining margin）会产生折叠

> 垂直的相邻margin会产生折叠，除了：

+ 根元素的margin不会折叠
+ 如果一个通过使用`clear`产生了空隙的元素的`maring-top`和`margin-bottom`产生了折叠，那么他会与其同文档流中的相邻元素产生margin折叠，这个折叠后的`margin-bottom`并不会影响他们的父元素的`margin-bottom`【*当文档流中有clear属性用来清除浮动时，下面那条最后一个节点的margin-bottom与父亲的margin-bottom*折叠不成立】

> 横向margin不会产生折叠

即`margin-left`和`margin-right`不产生折叠

> 判断两个margin是否为相邻的条件：【*若判定不相邻，则必然不会产生折叠*】

+ 两个都属于块级流中的盒元素使用同一个BFC（块级格式化上下文）
+ 没有`line box`【*行元素*】、没有`clearance`【*空隙，调用clear属性会导致*】、没有`padding`、没有`border`分离他们（提示：0高的行元素并不在此限制内）
+ 两者都属于垂直相邻边框，即以下形式之一：
	+ 一个元素的`margin-top`和他的第一个子元素的`margin-top`会被认为是相邻
	+ 一个元素的`margin-bottom`和同属于他文档流内的下一个节点的`margin-top`会被认为是相邻【*这意味一个元素他下一个元素如果是display:none的元素，不符合此描述，因为display:none的元素会脱离文档流，这还意味着translate3d的元素亦如此*】
	+ 如果一个元素位于所属文档流的最后一个而且其父元素拥有`height:auto`属性时，那么这个元素的`margin-bottom`会和其父元素的`margin-bottom`会被认为是相邻
	+ 当一个元素没有新建BFC，而且拥有`min-height:0`、`height:0或者auto`并且在文档流内没有子元素，那么他的`margin-top`和`maring-bottom`会被认为是相邻【例如：普通a标签，标签内写文字会有此效果，表现就是他的边距是上下一样的】

> 一个折叠margin会被认为

提示：相邻的margin可以通过不相关的兄弟元素或祖先元素产生

上述规则意味着：

+ 浮动元素不与任何其他元素产生margin折叠（包括他在文档流中父子元素）
+ 绝对定位的元素不会产生margin折叠（包括他在文档流中的父子元素）
+ `inline-block`元素不会产生margin折叠（包括他在文档流中的父子元素）
+ 会产生新的BFC的元素不会与他的子元素发生margin折叠（例如浮动元素和设置了`overflow`元素的可视部分）
+ 一个元素的`margin-top`会与他文档流内的下一个元素的`margin-top`发生折叠，当且仅当：
	+ 该元素与其下一个元素在同一个文档流内，且都为块级元素
	+ 这个元素的下一个元素不产生空隙
+ 一个元素的`margin-top`与他的父元素的`margin-top`发生margin折叠，当且仅当：【*上面例子就是*】
	+ 该元素为块级元素，且为其文档流中的第一个子元素
	+ 父元素为文档流中的块级元素
	+ 父元素没有`border-top`、`padding-top`和间隙
+ 一个元素的`margin-bottom`会与父元素的`margin-bottom`折叠，当且仅当：【有很多神奇的问题，都由这个属性导致】
	+ 这个元素不产生间隙
	+ 本身为块级元素，且位于其文档流中的最后一个
	+ 父元素是文档流内的块级元素
	+ 父元素满足`height:auto`和`min-height:0`属性
	+ 父元素没有`padding-bottom`和`border-bottom`属性
+ 如果一个元素的`margin-top`会与自己的`margin-bottom`折叠，当且仅当
	+ `min-height:0`
	+ 没有`padding-top`、`padding-bottom`、`border-top`、`border-bottom`
	+ `height:auto或0`
	+ 不包含行元素
	+ 其文档流内的全部子元素的margin都折叠

可以尝试通过上面的描述玩一下下面这个例子，并解释其原因来理解这个概念
<iframe height='268' width='500' scrolling='no' src='//codepen.io/Naixor/embed/mVVGzj/?height=268&theme-id=0&default-tab=result' frameborder='no' allowtransparency='true' allowfullscreen='true' style='width: 100%;'>See the Pen <a href='http://codepen.io/Naixor/pen/mVVGzj/'>mVVGzj</a> by Stormspirit (<a href='http://codepen.io/Naixor'>@Naixor</a>) on <a href='http://codepen.io'>CodePen</a>.
</iframe>

#### 注解
> [`间隙`](http://www.w3.org/TR/CSS2/visuren.html#clearance)在规范中的描述为：

当一个元素使用`clear`属性打断`float`时会产生间隙（clearance）

> [`BFC(block formatting context)`](http://www.w3.org/TR/CSS2/visuren.html#block-formatting)块级布局上下文：与其对应的是[`IFC(inline formatting context)`](http://www.w3.org/TR/CSS2/visuren.html#block-formatting)

+ 在BFC中，盒子从顶端开始垂直地一个接一个地排列，两个盒子之间的垂直的间隙是由他们的margin 值所决定的。在一个BFC中，两个相邻的块级盒子的垂直外边距会产生折叠。
+ 在BFC中，每一个盒子的左外边缘（margin-left）会触碰到容器的左边缘(border-left)（对于从右到左的格式来说，则触碰到右边缘）
> `什么元素会创建BFC`

浮动元素、绝对定位元素、不是块级元素的块级容器（inline-block，table-cells、table-captions）、拥有overflow属性的块级元素的可视区域会创建新的BFC


### Future

吾辈需谦虚谨慎的学习CSS规范打法，陆续更新...